<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARA System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #334155; }
        
        .layout { display: grid; grid-template-columns: 1fr 400px; height: 100vh; }
        .main-content { padding: 2rem; overflow-y: auto; }
        .side-panel { background: white; border-left: 1px solid #e2e8f0; transform: translateX(100%); transition: transform 0.3s ease; overflow-y: auto; }
        .side-panel.open { transform: translateX(0); }
        
        .header { margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; }
        .header p { color: #64748b; font-size: 1.1rem; margin-bottom: 1.5rem; }
        
        .search-bar { max-width: 500px; margin-bottom: 2rem; position: relative; }
        .search-input { width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; }
        .search-input:focus { outline: none; border-color: #3b82f6; }
        
        .buckets { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .bucket { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid; }
        .bucket.project { border-left-color: #3b82f6; }
        .bucket.area { border-left-color: #10b981; }
        .bucket.resource { border-left-color: #f59e0b; }
        .bucket.archive { border-left-color: #6b7280; }
        .bucket.action { border-left-color: #ef4444; }
        
        .bucket-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .bucket-title { font-size: 1.25rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .add-btn { background: #3b82f6; color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; }
        .add-btn:hover { background: #2563eb; }
        
        .add-form { display: none; background: #f8fafc; border-radius: 8px; padding: 1rem; margin-top: 1rem; border: 1px solid #e2e8f0; }
        .add-form.active { display: block; }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #3b82f6; }
        
        .form-actions { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; border: none; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        
        .items { min-height: 100px; }
        .item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .item:hover { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1); }
        .item-title { font-weight: 600; margin-bottom: 0.5rem; color: #1e293b; }
        .item-desc { color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .item-meta { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .status-badge { background: #ddd6fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        .field-badge { background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        
        .side-panel-header { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .side-panel-content { padding: 1.5rem; }
        .close-panel { float: right; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
        
        .empty-state { text-align: center; color: #9ca3af; font-style: italic; padding: 2rem; }
        
        .nav { margin-bottom: 1rem; }
        .nav a { color: #3b82f6; text-decoration: none; margin-right: 1rem; }
        .nav a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="main-content">
            <div class="header">
                <h1>PARA System</h1>
                <p>Projects • Areas • Resources • Archives • Actions</p>
                <div class="nav">
                    <a href="/fields">⚙️ Manage Custom Fields</a>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search items..." id="search-input">
                </div>
            </div>
            
            <div class="buckets">
                <div class="bucket project">
                    <div class="bucket-header">
                        <h2 class="bucket-title">Projects</h2>
                        <button class="add-btn" onclick="toggleAddForm('PROJECT')">+ Add</button>
                    </div>
                    <div class="add-form" id="add-form-PROJECT">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="title-PROJECT" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="description-PROJECT"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status-PROJECT"></select>
                        </div>
                        <div id="fields-PROJECT"></div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="createItem('PROJECT')">Create</button>
                            <button class="btn btn-secondary" onclick="cancelAdd('PROJECT')">Cancel</button>
                        </div>
                    </div>
                    <div class="items" id="projects-items">
                        <div class="empty-state">No projects yet</div>
                    </div>
                </div>
                
                <div class="bucket area">
                    <div class="bucket-header">
                        <h2 class="bucket-title">Areas</h2>
                        <button class="add-btn" onclick="toggleAddForm('AREA')">+ Add</button>
                    </div>
                    <div class="add-form" id="add-form-AREA">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="title-AREA" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="description-AREA"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status-AREA"></select>
                        </div>
                        <div id="fields-AREA"></div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="createItem('AREA')">Create</button>
                            <button class="btn btn-secondary" onclick="cancelAdd('AREA')">Cancel</button>
                        </div>
                    </div>
                    <div class="items" id="areas-items">
                        <div class="empty-state">No areas yet</div>
                    </div>
                </div>
                
                <div class="bucket resource">
                    <div class="bucket-header">
                        <h2 class="bucket-title">Resources</h2>
                        <button class="add-btn" onclick="toggleAddForm('RESOURCE')">+ Add</button>
                    </div>
                    <div class="add-form" id="add-form-RESOURCE">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="title-RESOURCE" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="description-RESOURCE"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status-RESOURCE"></select>
                        </div>
                        <div id="fields-RESOURCE"></div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="createItem('RESOURCE')">Create</button>
                            <button class="btn btn-secondary" onclick="cancelAdd('RESOURCE')">Cancel</button>
                        </div>
                    </div>
                    <div class="items" id="resources-items">
                        <div class="empty-state">No resources yet</div>
                    </div>
                </div>
                
                <div class="bucket archive">
                    <div class="bucket-header">
                        <h2 class="bucket-title">Archives</h2>
                        <button class="add-btn" onclick="toggleAddForm('ARCHIVE')">+ Add</button>
                    </div>
                    <div class="add-form" id="add-form-ARCHIVE">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="title-ARCHIVE" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="description-ARCHIVE"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status-ARCHIVE"></select>
                        </div>
                        <div id="fields-ARCHIVE"></div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="createItem('ARCHIVE')">Create</button>
                            <button class="btn btn-secondary" onclick="cancelAdd('ARCHIVE')">Cancel</button>
                        </div>
                    </div>
                    <div class="items" id="archives-items">
                        <div class="empty-state">No archives yet</div>
                    </div>
                </div>
                
                <div class="bucket action">
                    <div class="bucket-header">
                        <h2 class="bucket-title">Actions</h2>
                        <button class="add-btn" onclick="toggleAddForm('ACTION')">+ Add</button>
                    </div>
                    <div class="add-form" id="add-form-ACTION">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="title-ACTION" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="description-ACTION"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status-ACTION"></select>
                        </div>
                        <div id="fields-ACTION"></div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="createItem('ACTION')">Create</button>
                            <button class="btn btn-secondary" onclick="cancelAdd('ACTION')">Cancel</button>
                        </div>
                    </div>
                    <div class="items" id="actions-items">
                        <div class="empty-state">No actions yet</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="side-panel" id="detail-panel">
            <div class="side-panel-header">
                <h3 id="panel-title">Item Details</h3>
                <button class="close-panel" onclick="closePanel()">×</button>
            </div>
            <div class="side-panel-content" id="panel-content">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        const statuses = {
            PROJECT: ['Planning', 'In Progress', 'On Hold', 'Completed'],
            AREA: ['Active', 'Needs Attention', 'Maintaining'],
            RESOURCE: ['Available', 'In Use', 'Outdated'],
            ARCHIVE: ['Archived'],
            ACTION: ['Next', 'Waiting', 'Someday', 'Done']
        };

        let currentItem = null;

        async function toggleAddForm(bucket) {
            const form = document.getElementById(`add-form-${bucket}`);
            const isActive = form.classList.contains('active');
            
            // Close all forms
            document.querySelectorAll('.add-form').forEach(f => f.classList.remove('active'));
            
            if (!isActive) {
                form.classList.add('active');
                await loadBucketFields(bucket);
                populateStatusSelect(bucket);
            }
        }

        function cancelAdd(bucket) {
            document.getElementById(`add-form-${bucket}`).classList.remove('active');
            clearForm(bucket);
        }

        function clearForm(bucket) {
            document.getElementById(`title-${bucket}`).value = '';
            document.getElementById(`description-${bucket}`).value = '';
            document.getElementById(`fields-${bucket}`).innerHTML = '';
        }

        function populateStatusSelect(bucket) {
            const select = document.getElementById(`status-${bucket}`);
            select.innerHTML = statuses[bucket].map(status => 
                `<option value="${status}">${status}</option>`
            ).join('');
        }

        async function loadBucketFields(bucket) {
            try {
                const response = await fetch(`/api/bucket-fields/${bucket}`);
                const fields = await response.json();
                const container = document.getElementById(`fields-${bucket}`);
                
                if (fields.length === 0) {
                    container.innerHTML = '';
                } else {
                    container.innerHTML = fields.map(field => `
                        <div class="form-group">
                            <label class="form-label">${field.name} (${field.type})</label>
                            ${createFieldInput(field)}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load bucket fields:', error);
            }
        }

        function createFieldInput(field) {
            const fieldId = `field-${field.id}`;
            const defaultValue = field.defaultValue;
            
            switch(field.type) {
                case 'boolean':
                    const checked = defaultValue === true ? 'checked' : '';
                    return `<input type="checkbox" id="${fieldId}" data-field-id="${field.id}" data-field-type="${field.type}" ${checked}>`;
                    
                case 'date':
                    const dateValue = defaultValue ? `value="${defaultValue}"` : '';
                    return `<input type="date" class="form-input" id="${fieldId}" data-field-id="${field.id}" data-field-type="${field.type}" ${dateValue}>`;
                    
                case 'datetime':
                    const datetimeValue = defaultValue ? `value="${defaultValue}"` : '';
                    return `<input type="datetime-local" class="form-input" id="${fieldId}" data-field-id="${field.id}" data-field-type="${field.type}" ${datetimeValue}>`;
                    
                case 'array':
                    if (field.arrayOptions && field.arrayOptions.length > 0) {
                        const multiple = field.multiSelect ? 'multiple' : '';
                        const options = field.arrayOptions.map(option => {
                            const selected = defaultValue && defaultValue.includes(option) ? 'selected' : '';
                            return `<option value="${option}" ${selected}>${option}</option>`;
                        }).join('');
                        return `<select class="form-select" id="${fieldId}" data-field-id="${field.id}" data-field-type="${field.type}" data-multi-select="${field.multiSelect}" ${multiple}>${options}</select>`;
                    } else {
                        const arrayValue = defaultValue && Array.isArray(defaultValue) ? defaultValue.join(', ') : '';
                        return `<input type="text" class="form-input" id="${fieldId}" placeholder="Comma-separated values" data-field-id="${field.id}" data-field-type="${field.type}" value="${arrayValue}">`;
                    }
                    
                default:
                    const textValue = defaultValue ? `value="${defaultValue}"` : '';
                    return `<input type="text" class="form-input" id="${fieldId}" data-field-id="${field.id}" data-field-type="${field.type}" ${textValue}>`;
            }
        }

        async function createItem(bucket) {
            const title = document.getElementById(`title-${bucket}`).value.trim();
            const description = document.getElementById(`description-${bucket}`).value.trim();
            const statusName = document.getElementById(`status-${bucket}`).value;

            if (!title) {
                alert('Title is required');
                return;
            }

            // Collect custom fields
            const extraFields = {};
            document.querySelectorAll(`#fields-${bucket} [data-field-id]`).forEach(input => {
                const fieldId = input.dataset.fieldId;
                const fieldType = input.dataset.fieldType;
                const fieldName = input.previousElementSibling.textContent.split(' (')[0];
                
                let value;
                switch(fieldType) {
                    case 'boolean':
                        value = input.checked;
                        break;
                    case 'array':
                        if (input.tagName === 'SELECT') {
                            if (input.dataset.multiSelect === 'true') {
                                value = Array.from(input.selectedOptions).map(option => option.value);
                            } else {
                                value = input.value ? [input.value] : [];
                            }
                        } else {
                            value = input.value.trim() ? input.value.split(',').map(v => v.trim()) : [];
                        }
                        break;
                    case 'date':
                    case 'datetime':
                        value = input.value;
                        break;
                    default:
                        value = input.value.trim();
                }
                
                if (value !== '' && !(Array.isArray(value) && value.length === 0) && value !== false) {
                    extraFields[fieldName] = { type: fieldType, value };
                }
            });

            try {
                const response = await fetch('/api/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bucket, title, description, statusName, extraFields })
                });

                if (response.ok) {
                    cancelAdd(bucket);
                    loadItems();
                } else {
                    alert('Failed to create item');
                }
            } catch (error) {
                console.error('Failed to create item:', error);
                alert('Failed to create item');
            }
        }

        function showItemDetails(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            currentItem = item;
            document.getElementById('panel-title').textContent = item.title;
            document.getElementById('panel-content').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p>${item.description || 'No description'}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <p>${item.status || 'No status'}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Custom Fields</label>
                    ${Object.keys(item.extraFields || {}).length > 0 ? 
                        Object.entries(item.extraFields).map(([key, fieldData]) => 
                            `<p><strong>${key}:</strong> ${formatFieldValue(fieldData)}</p>`
                        ).join('') : 
                        '<p>No custom fields</p>'
                    }
                </div>
            `;
            document.getElementById('detail-panel').classList.add('open');
        }

        function closePanel() {
            document.getElementById('detail-panel').classList.remove('open');
        }

        function formatFieldValue(fieldData) {
            if (typeof fieldData !== 'object' || !fieldData.type) {
                return fieldData;
            }
            
            const { type, value } = fieldData;
            
            switch(type) {
                case 'boolean':
                    return value ? '✓' : '✗';
                case 'array':
                    return Array.isArray(value) ? value.join(', ') : value;
                case 'date':
                    return new Date(value).toLocaleDateString();
                case 'datetime':
                    return new Date(value).toLocaleString();
                default:
                    return value;
            }
        }

        let allItems = [];

        async function loadItems() {
            try {
                const response = await fetch('/api/items');
                allItems = await response.json();
                displayItems(allItems);
            } catch (error) {
                console.error('Failed to load items:', error);
            }
        }

        function displayItems(items) {
            ['PROJECT', 'AREA', 'RESOURCE', 'ARCHIVE', 'ACTION'].forEach(bucket => {
                const container = document.getElementById(`${bucket.toLowerCase()}s-items`);
                const bucketItems = items.filter(item => item.bucket === bucket);
                
                if (bucketItems.length === 0) {
                    container.innerHTML = `<div class="empty-state">No ${bucket.toLowerCase()}s yet</div>`;
                } else {
                    container.innerHTML = bucketItems.map(item => {
                        const customFields = Object.entries(item.extraFields || {}).map(([key, fieldData]) => {
                            const displayValue = formatFieldValue(fieldData);
                            return `<span class="field-badge">${key}: ${displayValue}</span>`;
                        }).join('');
                        
                        return `
                            <div class="item" onclick="showItemDetails('${item.id}')">
                                <div class="item-title">${item.title}</div>
                                ${item.description ? `<div class="item-desc">${item.description}</div>` : ''}
                                <div class="item-meta">
                                    <span class="status-badge">${item.status || 'No Status'}</span>
                                    ${customFields}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            });
        }

        // Load items on page load
        loadItems();

        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query) {
                const filtered = allItems.filter(item => 
                    item.title.toLowerCase().includes(query) ||
                    (item.description && item.description.toLowerCase().includes(query))
                );
                displayItems(filtered);
            } else {
                displayItems(allItems);
            }
        });
    </script>
</body>
</html>
